type: Pipeline
concurrency: -1
metrics:
  enabled: true
  requests:
    - id: "service_app_cpu_by_namespace_rate"
      type: "prometheus"
      url: "https://prometheus.state.api.cresplanex.org/api/v1/query"
      query: 'sum by(namespace) (rate(container_cpu_usage_seconds_total{container!="POD",container!="",namespace!="kube-system", image=~"docker.io/ablankz/.*",  image!="docker.io/ablankz/debezium:1.0.0", job="kubelet"}[3m]))'
      interval: 5s
      data:
        - key: "CPUUsage"
          jmesPath: "data.result[*].value[1] | [0]"
        - key: "AuthCPUUsage"
          jmesPath: "data.result[?metric.namespace=='auth-service'].value[1] | [0]"
        - key: "WebsocketCPUUsage"
          jmesPath: "data.result[?metric.namespace=='websocket-service'].value[1] | [0]"
        - key: "WebGatewayCPUUsage"
          jmesPath: "data.result[?metric.namespace=='web-gateway'].value[1] | [0]"
        - key: "JobCPUUsage"
          jmesPath: "data.result[?metric.namespace=='job-service'].value[1] | [0]"
        - key: "UserProfileCPUUsage"
          jmesPath: "data.result[?metric.namespace=='user-profile-service'].value[1] | [0]"
        - key: "UserPreferenceCPUUsage"
          jmesPath: "data.result[?metric.namespace=='user-preference-service'].value[1] | [0]"
        - key: "OrganizationCPUUsage"
          jmesPath: "data.result[?metric.namespace=='organization-service'].value[1] | [0]"
        - key: "TeamCPUUsage"
          jmesPath: "data.result[?metric.namespace=='team-service'].value[1] | [0]"
        - key: "PlanCPUUsage"
          jmesPath: "data.result[?metric.namespace=='plan-service'].value[1] | [0]"
        - key: "StorageCPUUsage"
          jmesPath: "data.result[?metric.namespace=='storage-service'].value[1] | [0]"
    - id: "service_app_cpu_by_namespace"
      type: "prometheus"
      url: "https://prometheus.state.api.cresplanex.org/api/v1/query"
      query: 'sum by(namespace) (container_cpu_usage_seconds_total{container!="POD",container!="",namespace!="kube-system", image=~"docker.io/ablankz/.*",  image!="docker.io/ablankz/debezium:1.0.0", job="kubelet"})'
      interval: 5s
      data:
        - key: "CPUUsage"
          jmesPath: "data.result[*].value[1] | [0]"
        - key: "AuthCPUUsage"
          jmesPath: "data.result[?metric.namespace=='auth-service'].value[1] | [0]"
        - key: "WebsocketCPUUsage"
          jmesPath: "data.result[?metric.namespace=='websocket-service'].value[1] | [0]"
        - key: "WebGatewayCPUUsage"
          jmesPath: "data.result[?metric.namespace=='web-gateway'].value[1] | [0]"
        - key: "JobCPUUsage"
          jmesPath: "data.result[?metric.namespace=='job-service'].value[1] | [0]"
        - key: "UserProfileCPUUsage"
          jmesPath: "data.result[?metric.namespace=='user-profile-service'].value[1] | [0]"
        - key: "UserPreferenceCPUUsage"
          jmesPath: "data.result[?metric.namespace=='user-preference-service'].value[1] | [0]"
        - key: "OrganizationCPUUsage"
          jmesPath: "data.result[?metric.namespace=='organization-service'].value[1] | [0]"
        - key: "TeamCPUUsage"
          jmesPath: "data.result[?metric.namespace=='team-service'].value[1] | [0]"
        - key: "PlanCPUUsage"
          jmesPath: "data.result[?metric.namespace=='plan-service'].value[1] | [0]"
        - key: "StorageCPUUsage"
          jmesPath: "data.result[?metric.namespace=='storage-service'].value[1] | [0]"
    - id: "memory_by_namespace_rate"
      type: "prometheus"
      url: "https://prometheus.state.api.cresplanex.org/api/v1/query"
      query: 'sum by(namespace) (rate(container_memory_working_set_bytes{container!="POD",container!="",namespace!="kube-system", image=~"docker.io/ablankz/.*",  image!="docker.io/ablankz/debezium:1.0.0", job="kubelet"}[3m]))'
      interval: 5s
      data:
        - key: "MemoryUsage"
          jmesPath: "data.result[*].value[1] | [0]"
        - key: "AuthMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='auth-service'].value[1] | [0]"
        - key: "WebsocketMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='websocket-service'].value[1] | [0]"
        - key: "WebGatewayMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='web-gateway'].value[1] | [0]"
        - key: "JobMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='job-service'].value[1] | [0]"
        - key: "UserProfileMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='user-profile-service'].value[1] | [0]"
        - key: "UserPreferenceMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='user-preference-service'].value[1] | [0]"
        - key: "OrganizationMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='organization-service'].value[1] | [0]"
        - key: "TeamMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='team-service'].value[1] | [0]"
        - key: "PlanMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='plan-service'].value[1] | [0]"
        - key: "StorageMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='storage-service'].value[1] | [0]"
    - id: "memory_by_namespace"
      type: "prometheus"
      url: "https://prometheus.state.api.cresplanex.org/api/v1/query"
      query: 'sum by(namespace) (container_memory_working_set_bytes{container!="POD",container!="",namespace!="kube-system", image=~"docker.io/ablankz/.*",  image!="docker.io/ablankz/debezium:1.0.0", job="kubelet"})'
      interval: 5s
      data:
        - key: "MemoryUsage"
          jmesPath: "data.result[*].value[1] | [0]"
        - key: "AuthMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='auth-service'].value[1] | [0]"
        - key: "WebsocketMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='websocket-service'].value[1] | [0]"
        - key: "WebGatewayMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='web-gateway'].value[1] | [0]"
        - key: "JobMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='job-service'].value[1] | [0]"
        - key: "UserProfileMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='user-profile-service'].value[1] | [0]"
        - key: "UserPreferenceMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='user-preference-service'].value[1] | [0]"
        - key: "OrganizationMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='organization-service'].value[1] | [0]"
        - key: "TeamMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='team-service'].value[1] | [0]"
        - key: "PlanMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='plan-service'].value[1] | [0]"
        - key: "StorageMemoryUsage"
          jmesPath: "data.result[?metric.namespace=='storage-service'].value[1] | [0]"
files:
  # - id: "sock_connect"
  #   file: "common/connect_socket.yaml"
  - id: "exec"
    file: "prod/exec.yaml"
    threadOnlyValues:
      - key: "count"
        value: "10"